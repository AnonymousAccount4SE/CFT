# Copy, move, delete files
# Copy and modify files (text files)
# Build command files and sql files, and execute them
# Execute tasks in a hiearchical way
# Define dependencies between tasks, to schedule a safe sequence
# Create directories, touch files
# Delete directories and files
# Create detailed log
# Date and time formatting and parsing

config task sql (
	IN File stdin
	OUT File fileOutput
	OUT File stdout
	OUT File stderr	
) is {
	@ isql -U${user:sa} -P${password:n84u2c} -S${system:TESTMVRS} -i$(stdin) -o${fileOutput}
	> run
	
	fileOutput > log
}
	
config task stopTomcat () {
	@ ${cmd:net stop tomcat8}
	> run
}

config task startTomcat () {
	${cmd:net start tomcat8}
	> run
}


task importDump {
	stopTomcat();
	
	[Stop database]
	@ SELECT 'kill '+convert(CHAR(4),spid)+CHAR(10)+'go' FROM master..sysprocesses WHERE dbid=db_id('mvrs_003')
	@ go
	> sql > sql
	
	[Load dump]
	@ load database ${db_name:mvrs_003} from '${dump_file d:\TestInit\mvrs_002.dmp}'
	@ go
	@ online database ${db_name:mvrs_003}
	@ go
	> sql
	
	[Configure users]
	@ sp_configure 'allow updates to system tables',1
	@ go
	@ USE ${db_name:mvrs_003}
	@ go
	@ IF db_name()<>'${db_name:mvrs_003}' select syb_quit()
	@ go
	@ DELETE sysusers WHERE suid>2
	@ go
	@ use ${db_name:mvrs_003}
	@ go
	@ exec sp_adduser 'impex_user_mvrs_003' ,'impex_user_mvrs_003' ,'impex'
	@ exec sp_adduser 'web_user_mvrs_003' ,'web_user_mvrs_003' ,'tng_web'
	@ go
	@ use master
	@ go
	@ sp_configure 'allow updates to system tables',0
	@ go
	> sql
	
	[Copy files]
	@ d:\TestInit\www.touchmvr.com
	> dir -recursive 
	> {->file
		
	}
	files recursive=true dir="d:\TestInit\www.touchmvr.com" {->file
		if file endsWith "\mvrs.properties" {
			replace {
				"mvrs_002" -> "mvrs003";
				"10.113.156.35" -> "mvrs003.test.systor.st"
			}
		} else if file endsWith "\GNT.properties"
			
	copy d:\TestInit\www.touchmvr.com d:\wwwhome\mvrs003.test.systor.st
	
	
	
	
task [Stop Tomcat] :- (run "net stop tomcat8")




(def SQL 